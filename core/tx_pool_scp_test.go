package core

import (
	"context"
	"math/big"
	"testing"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/core/script/erc"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/crypto"
	"github.com/ethereum/go-ethereum/ethclient"
	"github.com/sirupsen/logrus"
)

func TestDOTxScriptBuy(t *testing.T) {

	data := `38ed173900000000000000000000000000000000000000000000043C33C19375648000000000000000000000000000000000000000000000000005A59A5510F2C2D1000000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000bee95fd1c50099a8fff5204efd53c77900ab5052ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000020000000000000000000000008e81fcc2d4a3baa0ee9044e0d7e36f59c9bba9c1000000000000000000000000770d9d14c4ae2f78dca810958c1d9b7ea4620289`
	amount, _ := new(big.Int).SetString("20000749999999997500000", 10)
	tx := types.NewTransaction(1, common.HexToAddress("0x80a5A916FB355A8758f0a3e47891dc288DAC2665"), amount, 12345, new(big.Int), []byte(data))
	DOTxScript(*tx, "nil")
}

func TestDOTxScriptSolt(t *testing.T) {

	data := `38ed17390000000000000000000000000000000000000000000000001bc16d674ec80000000000000000000000000000000000000000000000000000148d29f70dc6491a00000000000000000000000000000000000000000000000000000000000000a00000000000000000000000003a3b580ac38ae2b937eb2d8848dec11fda317f82ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000770d9d14c4ae2f78dca810958c1d9b7ea46202890000000000000000000000008e81fcc2d4a3baa0ee9044e0d7e36f59c9bba9c1`
	amount, _ := new(big.Int).SetString("20000749999999997500000", 10)
	tx := types.NewTransaction(1, common.HexToAddress("0x80a5A916FB355A8758f0a3e47891dc288DAC2665"), amount, 300000, new(big.Int).SetInt64(100000000001), common.Hex2Bytes(data))
	DOTxScript(*tx, "nil")
}

func TestSendTx(t *testing.T) {

	client, err := ethclient.Dial(nodeWebSite) // 本地节点的默认RPC端口
	if err != nil {
		panic(err)
	}

	gas, err := client.SuggestGasPrice(context.Background())
	if err != nil {
		panic(err)
	}

	data := `0x38ed1739
	0000000000000000000000000000000000000000000000003782dace9d900000
	00000000000000000000000000000000000000000000000094079cd1a42aa800
	00000000000000000000000000000000000000000000000000000000000000a0
	000000000000000000000000e8db41c5e9ef0f09a1e65f8dc8e9fef1879250a9
	ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
	0000000000000000000000000000000000000000000000000000000000000002
	000000000000000000000000770d9d14c4ae2f78dca810958c1d9b7ea4620289
	0000000000000000000000008e81fcc2d4a3baa0ee9044e0d7e36f59c9bba9c1`
	amount, _ := new(big.Int).SetString("20000749999999997500000", 10)
	tx := types.NewTransaction(1, common.HexToAddress("0x80a5a916fb355a8758f0a3e47891dc288dac2665"), amount, 30000, gas, []byte(data))
	coreERC20, err := erc.NewCore(common.HexToAddress(contract), client)

	if err != nil {
		panic(err)
	}

	coreSERC20 = &erc.CoreSession{
		Contract: coreERC20,
	}

	privateKey, err = crypto.HexToECDSA("0d858bc2319b164afdadc5e28d8e5ccbffc028d149a60b0ec678439fb975ef5f")
	if err != nil {
		panic(err)
	}
	nonce, err := client.PendingNonceAt(context.Background(), myAddress)
	if err != nil {
		logrus.Errorf("NonceAt  err : %v", err)
		return
	}
	intput, _ := new(big.Int).SetString("20000000000000000000000", 10)
	output, _ := new(big.Int).SetString("26666000000000000000000", 10)
	hash, err := SendTx(
		client,
		coreSERC20,
		*tx,
		privateKey,
		coin1,
		coin2,
		new(big.Int).SetInt64(1111), intput, output, new(big.Int).SetUint64(nonce))
	if err != nil {
		panic(err)
	}
	t.Logf("hash %v", hash)
}

func TestDOTxScript(t *testing.T) {

	data := `09c5eabe0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000038425071ba0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000003600000000000000000000000006553e4b6e5fa9fa3d6b5a9754f79b8c7f8ed7bb7000000000000000000000000770d9d14c4ae2f78dca810958c1d9b7ea46202890000000000000000000000008e81fcc2d4a3baa0ee9044e0d7e36f59c9bba9c1506c617942726964676500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d8d726c948176540000000000000000000000000000000000000000000000000a006c8cdf25ce209600000000000000000000000000000000000000000000000000000000066c2f91700000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000770d9d14c4ae2f78dca810958c1d9b7ea46202890000000000000000000000008e81fcc2d4a3baa0ee9044e0d7e36f59c9bba9c100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000026d61696e6e6574000000000000000000000000000000000000000000000000006d61696e6e657400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000`
	amount, _ := new(big.Int).SetString("20000749999999997500000", 10)
	tx := types.NewTransaction(1, common.HexToAddress("0x80a5A916FB355A8758f0a3e47891dc288DAC2665"), amount, 12345, new(big.Int), common.Hex2Bytes(data))
	DOTxScript(*tx, "nil")
}
